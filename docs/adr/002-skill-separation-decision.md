# ADR-002: Penpot スキルの単一構成維持

## Status

Accepted

## Context

Penpot スキル (`SKILL.md`) は単一ファイルで 5 つの機能領域をカバーしている:

1. **環境セットアップ** — Docker 起動/停止、MCP 接続
2. **デザインシステム構築** — トークン定義、コンポーネント作成、ライブラリ管理（8 フェーズ）
3. **デザイン作成** — UI/UX デザインの実装（4 フェーズ）
4. **外部パイプライン** — トークン同期、Style Dictionary、Storybook、ドキュメント、VRT
5. **コメント管理** — レビューコメントの取得・返信・解決

現状の規模:

| 指標 | 値 |
|---|---|
| SKILL.md 行数 | ~145 行 |
| 推定トークン数 | ~2,130 tokens |
| ルーティングエントリ | 12 |
| 参照ファイル | 19 |
| スクリプト | 10 |

[ADR-001](001-context-engineering-subagent.md) でサブエージェント委譲（MCP 操作のコンテキスト隔離）は決定済み。本 ADR はその上位の問い「スキル自体を分割すべきか」に回答する。

## Considered Alternatives

### 案 A: 3 分割（環境 / デザイン / パイプライン）

```
/penpot-env     — 環境セットアップ
/penpot-design  — デザインシステム構築 + デザイン作成 + コメント管理
/penpot-pipe    — 外部パイプライン（トークン同期、SD、Storybook 等）
```

**メリット**: 各スキルの責務が明確。パイプライン系は MCP 不要なので分離が自然。
**デメリット**: 共通参照（`mcp-api.md`, `penpot-init.js`）が `/penpot-design` と `/penpot-pipe` で重複。ユーザーが 3 つのスキル名を覚える必要がある。複合タスクで複数スキルの協調が必要になり、親エージェントのオーケストレーション負担が増加。

### 案 B: 2 分割（環境 / 機能）

```
/penpot-env     — 環境セットアップ
/penpot         — それ以外すべて
```

**メリット**: 環境操作（Docker/Bash のみ）と MCP 操作の分離が明確。
**デメリット**: 環境セットアップは他の操作の暗黙的前提であり、分離すると「まず `/penpot-env` で起動してから `/penpot` で…」とユーザーに 2 ステップを意識させる。単一スキルならルーティングマップ内で前提→本題へシームレスに遷移できる。分割の実質的メリットが薄い。

### 案 C: 現状維持（単一スキル）

```
/penpot         — 全機能を単一エントリポイントで提供
```

**メリット**: ユーザーは `/penpot` だけ覚えればよい。ルーティングマップが単一エントリポイントとして機能。共通参照の重複なし。複合タスクでスキル境界をまたぐ問題が発生しない。
**デメリット**: SKILL.md が肥大化した場合にトークン消費が増加する可能性。

## Decision

**案 C（単一スキル構成）を維持する。**

### 根拠

1. **SKILL.md 自体は軽量**
   SKILL.md は ~145 行（~2,130 tokens）であり、スキル注入のコストは低い。重いのは参照ファイル群（`mcp-api.md`, `design.md`, `workflow/phase-*.md` 等）だが、これらはルーティング後にオンデマンドで Read されるため、常時コンテキストを消費しない。

2. **ルーティングマップが単一エントリポイントとして機能**
   12 エントリのルーティングマップにより、ユーザーは `/penpot` という 1 つのスキル名を覚えるだけで全機能にアクセスできる。キーワードに応じて適切なセクション・参照ファイルに自動遷移する。

3. **ADR-001 のサブエージェント隔離が主要問題を解決済み**
   コンテキスト膨張の主因は MCP 操作の入出力（シェイプ構造、トークン一覧、バリデーション結果など）であり、これは [ADR-001](001-context-engineering-subagent.md) の `penpot-mcp` サブエージェントで隔離済み。スキル分割で解決すべき問題は残っていない。

4. **分割するとメンテナンス負担が増加**
   `mcp-api.md` と `penpot-init.js` は「デザインシステム構築」「デザイン作成」「コメント管理」「外部パイプライン（トークン同期）」の 4 領域で共通参照される。スキルを分割するとこれらの参照定義が重複し、変更時の同期漏れリスクが生じる。

5. **複合タスクはオーケストレーションで対応すべき**

   典型的な複合タスクの例:

   > 「Penpot で作成した TODO アプリのプロトタイプをもとに、アプリケーションを作成して」

   このタスクは以下のように複数領域にまたがる:

   ```
   環境セットアップ（暗黙的前提: Penpot が未起動なら自動起動）
     → デザイン読み取り（デザイン作成ルート: プロトタイプの構造・スタイル取得）
     → トークン同期（外部パイプラインルート: DTCG エクスポート → CSS 変数生成）
     → コード生成・実装（スキル外: フレームワークでのアプリ実装）
   ```

   単一スキルなら、ルーティングマップ内で「環境確認 → デザイン読み取り → トークン同期」とシームレスに遷移できる。スキルが分割されている場合、親エージェントが `/penpot-env` → `/penpot-design` → `/penpot-pipe` を順に呼び出す協調ロジックを担う必要があり、複雑さが増す。

   **スキルを分割しても、境界をまたぐオーケストレーション問題は解決しない。むしろ親エージェントの負担が増える。**

## Re-evaluation Triggers

以下の条件に達した場合、本決定を再検討する:

- **SKILL.md が 300 行を超えた場合** — トークン消費が無視できなくなる
- **ルーティングエントリが 20 を超えた場合** — ルーティングの複雑さが管理限界に近づく
- **新たな機能領域が追加され、既存領域との共通参照がない場合** — 独立したスキルとして分離する自然な境界が生まれる

## Consequences

### メリット

- **ユーザー体験の一貫性**: `/penpot` だけで全機能にアクセスでき、機能領域を意識する必要がない
- **メンテナンスの単純さ**: 参照ファイルの定義が一箇所に集約され、変更時の同期漏れリスクがない
- **複合タスクの自然な遷移**: 環境セットアップ → デザイン操作 → パイプラインがスキル内でシームレスに連携
- **ADR-001 との補完関係**: スキル（ルーティング・参照管理）とサブエージェント（MCP 操作隔離）の役割が明確に分離

### トレードオフ

- **スキル注入コスト**: 環境操作のみ必要な場合でも ~2,130 tokens の SKILL.md 全体が注入される（ただし参照ファイルの Read は発生しない）
- **単一障害点**: SKILL.md の構造が破損すると全機能に影響する（ただし Git 管理下のため復元は容易）
- **将来の肥大化リスク**: 新機能追加時に SKILL.md が長大化する可能性がある（再検討トリガーで対応）

## Related Files

| ファイル | 関連 |
|---|---|
| [ADR-001: MCP 操作のサブエージェント委譲](001-context-engineering-subagent.md) | 前提となる決定。コンテキスト隔離の主要施策 |
| [`.claude/skills/penpot/SKILL.md`](../../.claude/skills/penpot/SKILL.md) | 本 ADR の対象。単一構成を維持するスキル定義 |
| [`.claude/agents/penpot-mcp.md`](../../.claude/agents/penpot-mcp.md) | ADR-001 で導入されたサブエージェント定義 |
