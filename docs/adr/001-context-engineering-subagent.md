# ADR-001: MCP 操作のサブエージェント委譲によるコンテキスト隔離

## Status

Accepted

## Context

Penpot MCP を使ったデザインシステム構築や UI 作成では、1 つのタスクで多数の `execute_code` 呼び出しが必要になる。長時間の複合タスクで以下の問題が発生していた:

1. **コンテキスト膨張** — MCP 操作の入出力（シェイプ構造、トークン一覧、バリデーション結果など）がコンテキストウィンドウを急速に消費
2. **自動圧縮によるルーティング情報消失** — Claude Code の自動圧縮が発動すると、SKILL.md のルーティングマップや API 制約が失われ、誤った操作やツール名の取り違え（`mcp__ide__executeCode` vs `mcp__penpot-official__execute_code`）が発生
3. **状態復元の困難** — 圧縮後に「どのフェーズのどの操作まで完了したか」が不明になり、手戻りや重複操作が発生

## Decision

以下の 3 つの施策を導入する。

### 1. `.penpot-task.md` による状態永続化

SKILL.md の「複合タスクの実行管理」セクションに、タスク計画・進捗・キーパスをファイルに記録する規約を追加。コンテキスト圧縮後も Read で状態を復元できるようにする。

### 2. `penpot-mcp` サブエージェントで MCP 操作を隔離

`.claude/agents/penpot-mcp.md` を新設し、MCP 操作（ボード作成、テキスト配置、スタイル適用、トークン操作、デザイン検証など）を独立したサブエージェントに委譲する。

サブエージェントの設計方針:
- **ツール制限**: `mcp__penpot-official__*` 系 3 ツール + `Read` / `Grep` / `Glob` のみ
- **初期化手順を明記**: `penpot-init.js` と `mcp-api.md` の Read を必須とし、ツール名取り違えを防止
- **制約の内蔵**: fontFamily 制限、バッチ処理、token.value 読み取り専用などの API 制約をエージェント定義に直接記載
- **`model: inherit`**: 親エージェントと同じモデルを使用（品質維持）

### 3. リーン設計（`skills: [penpot]` を使わない）

サブエージェントに `skills: [penpot]` を設定すると SKILL.md 全体（~2,130 tokens）が注入される。サブエージェントは MCP 操作のみに特化するため、ルーティングマップや環境セットアップ手順は不要。必要な情報（初期化手順、API 制約）のみをエージェント定義に直接記載し、トークン消費を最小化する。

## Consequences

### メリット

- **コンテキスト隔離**: MCP 操作の入出力がサブエージェントのコンテキスト内で完結し、親のコンテキストウィンドウを保護
- **圧縮耐性**: ルーティング情報は親に残り、MCP 操作の詳細はサブエージェントが管理するため、自動圧縮の影響を軽減
- **状態復元**: `.penpot-task.md` により、圧縮後や会話再開時にもタスク状態を復元可能
- **IDE 互換**: Claude Code と GitHub Copilot の両方で動作（`.claude/agents/` は両ツール共通のサブエージェント定義形式）

### トレードオフ

- **レイテンシ増加**: サブエージェント起動のオーバーヘッドが加わる（ただし MCP 操作自体の所要時間に比べると軽微）
- **コンテキスト分断**: サブエージェントは親の会話履歴を持たないため、タスク指示を明示的に渡す必要がある
- **メンテナンス負担**: API 制約の変更時に SKILL.md とエージェント定義の両方を更新する必要がある

## Related Files

| ファイル | 変更内容 |
|---|---|
| [`.claude/skills/penpot/SKILL.md`](../../.claude/skills/penpot/SKILL.md) | 「複合タスクの実行管理」セクション追加 |
| [`.claude/agents/penpot-mcp.md`](../../.claude/agents/penpot-mcp.md) | サブエージェント定義（新規作成） |
