## Penpot Self-Hosting Configuration
## Usage:
##   cd penpot
##   cp .env.example .env   # Edit with your settings
##   docker compose up -d

name: penpot

x-flags: &penpot-flags
  PENPOT_FLAGS: >-
    enable-registration
    enable-login-with-password
    disable-email-verification
    disable-onboarding
    disable-onboarding-questions
    disable-onboarding-newsletter
    disable-onboarding-team
    enable-prepl-server
    disable-secure-session-cookies
    enable-access-tokens
    disable-telemetry
    enable-air-gapped-conf

x-uri: &penpot-public-uri
  PENPOT_PUBLIC_URI: ${PENPOT_PUBLIC_URI:-http://localhost:9001}

x-body-size: &penpot-http-body-size
  PENPOT_HTTP_SERVER_MAX_BODY_SIZE: 31457280
  PENPOT_HTTP_SERVER_MAX_MULTIPART_BODY_SIZE: 367001600

x-secret-key: &penpot-secret-key
  PENPOT_SECRET_KEY: ${PENPOT_SECRET_KEY:-change-this-insecure-key}

services:
  penpot-frontend:
    image: penpotapp/frontend:${PENPOT_VERSION:-2.13.2}
    restart: unless-stopped
    ports:
      - "${PENPOT_PORT:-9001}:8080"
    volumes:
      - penpot_assets:/opt/data/assets
      - ./patches:/opt/patches:ro
    entrypoint: ["/bin/sh", "/opt/patches/entrypoint-wrapper.sh"]
    command: ["nginx", "-g", "daemon off;"]
    depends_on:
      - penpot-backend
      - penpot-exporter
    environment:
      <<: [*penpot-flags, *penpot-http-body-size]
      PENPOT_BACKEND_URI: http://penpot-backend:6060
      PENPOT_EXPORTER_URI: http://penpot-exporter:6061
      ## Patches (set to false to disable)
      PENPOT_PATCH_IME_FIX: ${PENPOT_PATCH_IME_FIX:-true}
    networks:
      - penpot

  penpot-backend:
    image: penpotapp/backend:${PENPOT_VERSION:-2.13.2}
    restart: unless-stopped
    volumes:
      - penpot_assets:/opt/data/assets
    depends_on:
      penpot-postgres:
        condition: service_healthy
      penpot-valkey:
        condition: service_healthy
    environment:
      <<:
        [
          *penpot-flags,
          *penpot-public-uri,
          *penpot-http-body-size,
          *penpot-secret-key,
        ]
      PENPOT_DATABASE_URI: postgresql://penpot-postgres/penpot
      PENPOT_DATABASE_USERNAME: penpot
      PENPOT_DATABASE_PASSWORD: ${PENPOT_DB_PASSWORD:-penpot}
      PENPOT_REDIS_URI: redis://penpot-valkey/0
      PENPOT_OBJECTS_STORAGE_BACKEND: fs
      PENPOT_OBJECTS_STORAGE_FS_DIRECTORY: /opt/data/assets
    networks:
      - penpot

  penpot-exporter:
    image: penpotapp/exporter:${PENPOT_VERSION:-2.13.2}
    restart: unless-stopped
    depends_on:
      penpot-valkey:
        condition: service_healthy
    environment:
      <<: *penpot-secret-key
      PENPOT_PUBLIC_URI: http://penpot-frontend:8080
      PENPOT_REDIS_URI: redis://penpot-valkey/0
    networks:
      - penpot

  penpot-postgres:
    image: postgres:15
    restart: unless-stopped
    stop_signal: SIGINT
    volumes:
      - penpot_postgres_v15:/var/lib/postgresql/data
    environment:
      POSTGRES_INITDB_ARGS: --data-checksums
      POSTGRES_DB: penpot
      POSTGRES_USER: penpot
      POSTGRES_PASSWORD: ${PENPOT_DB_PASSWORD:-penpot}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U penpot"]
      interval: 2s
      timeout: 10s
      retries: 5
      start_period: 2s
    networks:
      - penpot

  penpot-valkey:
    image: valkey/valkey:8.1
    restart: unless-stopped
    command: >
      valkey-server
      --maxmemory 128mb
      --maxmemory-policy volatile-lfu
    healthcheck:
      test: ["CMD", "valkey-cli", "ping"]
      interval: 1s
      timeout: 5s
      retries: 5
      start_period: 1s
    networks:
      - penpot

  # MCP Server - Claude Code Instance
  penpot-mcp-claude:
    build:
      context: ./penpot-mcp
      args:
        PENPOT_REF: "develop"
    restart: unless-stopped
    depends_on:
      - penpot-frontend
    ports:
      - "${PENPOT_MCP_CLAUDE_PLUGIN_PORT:-4400}:4400"
      - "${PENPOT_MCP_CLAUDE_HTTP_PORT:-4401}:4401"
      - "${PENPOT_MCP_CLAUDE_WS_PORT:-4402}:4402"
    volumes:
      - ./patches/mcp-keepalive.cjs:/app/mcp-keepalive.cjs:ro
    environment:
      PENPOT_MCP_SERVER_LISTEN_ADDRESS: "0.0.0.0"
      PENPOT_MCP_SERVER_PORT: "4401"
      PENPOT_MCP_WEBSOCKET_PORT: "4402"
      PENPOT_MCP_REMOTE_MODE: "true"
      PENPOT_MCP_LOG_LEVEL: "${PENPOT_MCP_CLAUDE_LOG_LEVEL:-info}"
      NODE_OPTIONS: "-r /app/mcp-keepalive.cjs"
    networks:
      - penpot

  # MCP Server - GitHub Copilot Instance
  penpot-mcp-copilot:
    build:
      context: ./penpot-mcp
      args:
        PENPOT_REF: "develop"
    restart: unless-stopped
    depends_on:
      - penpot-frontend
    ports:
      - "${PENPOT_MCP_COPILOT_PLUGIN_PORT:-4410}:4400"
      - "${PENPOT_MCP_COPILOT_HTTP_PORT:-4411}:4401"
      - "${PENPOT_MCP_COPILOT_WS_PORT:-4412}:4402"
    volumes:
      - ./patches/mcp-keepalive.cjs:/app/mcp-keepalive.cjs:ro
    environment:
      PENPOT_MCP_SERVER_LISTEN_ADDRESS: "0.0.0.0"
      PENPOT_MCP_SERVER_PORT: "4401"
      PENPOT_MCP_WEBSOCKET_PORT: "4402"
      PENPOT_MCP_REMOTE_MODE: "true"
      PENPOT_MCP_LOG_LEVEL: "${PENPOT_MCP_COPILOT_LOG_LEVEL:-info}"
      NODE_OPTIONS: "-r /app/mcp-keepalive.cjs"
    networks:
      - penpot

  # MCP Auto-Connect + Bridge Server - Claude Code
  penpot-mcp-connect-claude:
    build:
      context: ./mcp-connect
    restart: unless-stopped
    depends_on:
      - penpot-frontend
      - penpot-mcp-claude
    environment:
      PENPOT_PUBLIC_URI: "http://penpot-frontend:8080"
      PENPOT_MCP_EMAIL: "${PENPOT_MCP_CLAUDE_EMAIL:-mcp-claude@penpot.local}"
      PENPOT_MCP_PASSWORD: "${PENPOT_MCP_CLAUDE_PASSWORD:-mcpclaude123}"
      PENPOT_MCP_MANIFEST_HOST: "penpot-mcp-claude"
      PENPOT_MCP_PLUGIN_PORT: "4400"
      MCP_SERVICE_NAME: "penpot-mcp-claude"
    networks:
      - penpot

  # MCP Auto-Connect + Bridge Server - GitHub Copilot
  penpot-mcp-connect-copilot:
    build:
      context: ./mcp-connect
    restart: unless-stopped
    depends_on:
      - penpot-frontend
      - penpot-mcp-copilot
    environment:
      PENPOT_PUBLIC_URI: "http://penpot-frontend:8080"
      PENPOT_MCP_EMAIL: "${PENPOT_MCP_COPILOT_EMAIL:-mcp-copilot@penpot.local}"
      PENPOT_MCP_PASSWORD: "${PENPOT_MCP_COPILOT_PASSWORD:-mcpcopilot123}"
      PENPOT_MCP_MANIFEST_HOST: "penpot-mcp-copilot"
      PENPOT_MCP_PLUGIN_PORT: "4400"
      MCP_SERVICE_NAME: "penpot-mcp-copilot"
    networks:
      - penpot

  # Penpot Design System Storybook
  penpot-storybook:
    image: penpotapp/storybook:${PENPOT_VERSION:-2.13.2}
    restart: unless-stopped
    ports:
      - "${PENPOT_STORYBOOK_PORT:-6006}:8080"
    networks:
      - penpot

volumes:
  penpot_postgres_v15:
  penpot_assets:

networks:
  penpot:
    driver: bridge
